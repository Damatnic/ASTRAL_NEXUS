/**
 * Quiz Generation from Guide Content
 * Creates multiple choice and true/false questions
 */

import { Guide } from './guides'

export interface QuizQuestion {
  id: string
  question: string
  type: 'multiple-choice' | 'true-false'
  options?: string[]
  correctAnswer: string
  explanation: string
  section: string
  difficulty: 'easy' | 'medium' | 'hard'
}

export function generateQuizFromGuide(guide: Guide, count: number = 10): QuizQuestion[] {
  const questions: QuizQuestion[] = []
  
  // Use manual quiz questions if available
  const manualQuizzes = manualQuizQuestions[guide.slug] || []
  questions.push(...manualQuizzes)

  // Auto-generate from content
  const autoGenerated = autoGenerateQuestions(guide)
  questions.push(...autoGenerated)

  // Shuffle and limit
  return shuffleArray(questions).slice(0, count)
}

function autoGenerateQuestions(guide: Guide): QuizQuestion[] {
  const questions: QuizQuestion[] = []
  const content = guide.content

  // Extract true/false statements from content
  const factRegex = /^[-*]\s+([^:\n]{20,150})$/gm
  let match
  let questionId = 0

  while ((match = factRegex.exec(content)) !== null) {
    const statement = match[1].trim()
    
    if (statement.length > 30 && questionId < 20) {
      questions.push({
        id: `auto-${questionId++}`,
        question: statement,
        type: 'true-false',
        correctAnswer: 'true',
        explanation: 'This statement is directly from the guide.',
        section: 'Content Recall',
        difficulty: 'easy',
      })
    }
  }

  return questions
}

function shuffleArray<T>(array: T[]): T[] {
  const shuffled = [...array]
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]
  }
  return shuffled
}

// High-quality manual quiz questions
export const manualQuizQuestions: Record<string, QuizQuestion[]> = {
  'body-language-mastery': [
    {
      id: 'bl-1',
      question: 'Which of the following is NOT one of the seven universal emotions identified by Paul Ekman?',
      type: 'multiple-choice',
      options: ['Happiness', 'Sadness', 'Confusion', 'Contempt'],
      correctAnswer: 'Confusion',
      explanation: 'The seven universal emotions are: Happiness, Sadness, Anger, Fear, Disgust, Surprise, and Contempt. Confusion is not one of them.',
      section: 'Facial Expressions',
      difficulty: 'medium',
    },
    {
      id: 'bl-2',
      question: 'A Duchenne smile involves only the mouth muscles.',
      type: 'true-false',
      correctAnswer: 'false',
      explanation: 'False. A Duchenne smile (genuine smile) involves both the mouth and the eyes, showing crow\'s feet wrinkles. A smile using only the mouth is a social/fake smile.',
      section: 'Facial Expressions',
      difficulty: 'easy',
    },
    {
      id: 'bl-3',
      question: 'What does the "baseline" refer to in body language reading?',
      type: 'multiple-choice',
      options: [
        'The person\'s normal behavior in a neutral state',
        'The minimum amount of eye contact needed',
        'The average body language across all people',
        'The starting position of a conversation'
      ],
      correctAnswer: 'The person\'s normal behavior in a neutral state',
      explanation: 'Baseline is a person\'s normal, typical behavior. You observe this first, then look for deviations from baseline which are more meaningful than absolute behaviors.',
      section: 'Fundamentals',
      difficulty: 'easy',
    },
    {
      id: 'bl-4',
      question: 'Crossed arms always indicate defensiveness or hostility.',
      type: 'true-false',
      correctAnswer: 'false',
      explanation: 'False. Crossed arms can mean defensiveness, but also that the person is cold, comfortable in that position, or listening intently. Always look for clusters of signals and context.',
      section: 'Gestures',
      difficulty: 'easy',
    },
    {
      id: 'bl-5',
      question: 'How long do microexpressions typically last?',
      type: 'multiple-choice',
      options: ['1/25th to 1/5th of a second', '1-2 seconds', '3-5 seconds', 'Half a second'],
      correctAnswer: '1/25th to 1/5th of a second',
      explanation: 'Microexpressions are extremely brief (0.04 to 0.2 seconds), showing true emotion before conscious suppression kicks in.',
      section: 'Microexpressions',
      difficulty: 'hard',
    },
  ],
  'legal-essentials': [
    {
      id: 'legal-1',
      question: 'You must have a lawyer present during all police interactions.',
      type: 'true-false',
      correctAnswer: 'false',
      explanation: 'False. You have the right to request a lawyer during custodial interrogation, but police can approach and talk to you in many situations. You can choose to remain silent and request a lawyer at any time.',
      section: 'Constitutional Rights',
      difficulty: 'medium',
    },
    {
      id: 'legal-2',
      question: 'What should you say if you are arrested?',
      type: 'multiple-choice',
      options: [
        '"I want to explain what happened"',
        '"I\'m invoking my right to remain silent. I want a lawyer."',
        '"I didn\'t do anything wrong"',
        'Try to negotiate with the officer'
      ],
      correctAnswer: '"I\'m invoking my right to remain silent. I want a lawyer."',
      explanation: 'You must clearly invoke your rights by saying "I\'m invoking my right to remain silent. I want a lawyer." Then stop talking. Anything you say can be used against you.',
      section: 'Criminal Law',
      difficulty: 'easy',
    },
    {
      id: 'legal-3',
      question: 'A contract must be in writing to be enforceable.',
      type: 'true-false',
      correctAnswer: 'false',
      explanation: 'False. Oral contracts are generally enforceable, though some contracts MUST be in writing under the Statute of Frauds (land sales, contracts taking >1 year, marriage promises, paying someone else\'s debt, sales of goods >$500).',
      section: 'Contract Law',
      difficulty: 'medium',
    },
  ],
  'ultimate-life-manual': [
    {
      id: 'life-1',
      question: 'According to the Rule of Threes, how long can you survive without water?',
      type: 'multiple-choice',
      options: ['3 hours', '3 days', '3 weeks', '3 months'],
      correctAnswer: '3 days',
      explanation: 'The Rule of Threes: 3 minutes without air, 3 hours without shelter (harsh conditions), 3 days without water, 3 weeks without food.',
      section: 'Emergency Preparedness',
      difficulty: 'easy',
    },
    {
      id: 'life-2',
      question: 'The 50/30/20 budgeting rule allocates 50% to needs, 30% to savings, and 20% to wants.',
      type: 'true-false',
      correctAnswer: 'false',
      explanation: 'False. The correct allocation is: 50% to needs (essentials), 30% to wants (discretionary), and 20% to savings and debt repayment.',
      section: 'Financial Mastery',
      difficulty: 'easy',
    },
    {
      id: 'life-3',
      question: 'What is the recommended amount of moderate cardio exercise per week?',
      type: 'multiple-choice',
      options: ['75 minutes', '100 minutes', '150 minutes', '200 minutes'],
      correctAnswer: '150 minutes',
      explanation: '150 minutes of moderate cardio or 75 minutes of vigorous cardio per week, plus 2-3 days of strength training.',
      section: 'Health & Fitness',
      difficulty: 'medium',
    },
  ],
}

